<%- model_class = Post -%>
<!-- Main Page Content -->
<% content_for :head do %>
<% @current_link = request.protocol+request.host_with_port+params[:blog].to_s+blog_posts_path %>
<%= auto_discovery_link_tag :atom, @current_link+".atom" %>
<%= auto_discovery_link_tag :rss,  @current_link+".rss" %>
<% end %>
<% @blog = Blog.find_by_slug(params[:blog_id]) %>
<% title @blog.title %>
<div class="row">
  <div class="span6 offset3">
    <h1 class="page-header">
      <%= link_to @blog.title, blog_posts_path %><br>
      <small class="blog-subtitle"><%= @blog.subtitle %></small>
    </h1>
  </div>
</div>
<!-- Main Blog Content -->
<div class="row">
  <div class="span6 offset3">
    <% @posts.each do |post| %>
      <section class="snippet">
        <h2><%= link_to post.title,  blog_post_path(post.blog,post) %></h2>
        <div>
          <span class="pull-right">
            <% if can? :update, post %>
              <%= link_to 'Edit post', edit_blog_post_path(post.blog,post), :class => 'btn btn-mini btn-warning' %>
            <% end %>
          </span>
          <h5 class="blog-author">by <%= link_to post.blog.user.username, post.blog.user, {:class => "overrideanchor"} %> on <%= post.created_at.strftime("%a, %b %d %Y at %l:%M %p") %> / <%= link_to (pluralize post.comments.count, "comment") , blog_post_path(post.blog, post) + "#comments", {:class => "overrideanchor"} %></h5>
        <% post_content = post.content.gsub(/\r\n?/,"").html_safe %>
        <% if post_content.length <= 200 %>
          <%= post_content %>
        <% else %>
          <%= post_content.split(" ").first(200).join(" ").html_safe %>[...] <%= link_to "Continued", blog_post_path(post.blog,post), {:class => "overrideanchor"} %>
        <% end %>
      </section>
    <% end %>
  <div id="paginator">
    <%= paginate @posts, :param_name => :page %>
  </div>
</div>
<!-- Main Blog Content End -->
<!--  SideBar Begin -->
<div class="span3">
  <% if can? :update, @blog %>
  <div class="span2">
    <div class="sidebar-title"><span class="badge">Manage blog</span></div><br>
    <div class="btn-grp sidebar-title">
      <%= link_to 'New post', new_blog_post_path, :class => 'btn btn-info' %>
    </div>
  </div>
  <% end %>
  <% tag_counts = @blog.posts.tag_counts.order('tags_count desc').first(15) %>
  <% if tag_counts.length > 0 %>
    <div class="span2 visible-desktop">
      <hr>
      <div class="sidebar-title"><span class="badge">Top tags</span></div><br>
      <% tag_cloud tag_counts, %w[s m l] do |tag| %>
        <%= link_to tag.name, tag_path(params[:blog_id], tag.name), :class => "label label-info tag" %>
        <span class="badge pull-right"><%= tag.count %></span>
        <br>
      <% end %>
    </div>
  <% end %>
</div>
<!-- End Sidebar Content -->
